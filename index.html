<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sigma Crypto Flash Sender - v1.5.4 </title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
        --bg-primary: #121212; /* Dark mode default */
        --bg-secondary: #1e1e1e;
        --bg-tertiary: #252525;
        --bg-modal: #1c1e22;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --text-tertiary: #8892a7;
        --accent-primary: #00e5b0;
        --accent-secondary: #00c9a7;
        --border-color: #2a2a2a;
        --border-color-light: #333;
        --shadow-color-soft: rgba(0,0,0,0.3);
        --shadow-color-strong: rgba(0,0,0,0.5);
        --button-text-dark: #121212;
        --success-color: #00e5b0;
        --error-color: #ff6b6b;
        --info-color: #66ccff;
        --warn-color: #ffcc66;
    }

    body.light-theme {
        --bg-primary: #f0f2f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8f9fa;
        --bg-modal: #ffffff;
        --text-primary: #2d3748;
        --text-secondary: #5a6578;
        --text-tertiary: #8892a7;
        --accent-primary: #1a73e8;
        --accent-secondary: #1557b0;
        --border-color: #dee2e6;
        --border-color-light: #e0e0e0;
        --shadow-color-soft: rgba(0,0,0,0.1);
        --shadow-color-strong: rgba(0,0,0,0.15);
        --button-text-dark: #ffffff;
        --success-color: #28a745;
        --error-color: #dc3545;
        --info-color: #17a2b8;
        --warn-color: #ffc107;
    }

    body { 
        font-family: 'Tajawal', Arial, sans-serif; 
        background: var(--bg-primary); 
        color: var(--text-primary); 
        margin: 0; padding: 0; line-height: 1.6; 
        transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 600px; margin: 40px auto; padding: 25px; background: var(--bg-secondary); border-radius: 12px; box-shadow: 0 8px 24px var(--shadow-color-soft); border: 1px solid var(--border-color);}
    h1 { text-align: center; color: var(--accent-primary); font-weight: 700; letter-spacing: 0.5px; }
    label { color: var(--text-secondary); margin-bottom: 8px !important; font-weight: 500; display: block; width: 100%; box-sizing: border-box;} 
    select, input[type="text"], input[type="number"], input[type="password"] { 
        padding: 12px 15px; 
        border: 1px solid var(--border-color-light); 
        border-radius: 8px; 
        background: var(--bg-tertiary); 
        color: var(--text-primary); 
        font-size: 1rem; 
        transition: border-color 0.3s, box-shadow 0.3s; 
        display: block; width: 100%; margin-bottom: 18px; box-sizing: border-box; font-family: 'Tajawal', sans-serif;
    }
    input:focus, select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 30%, transparent); outline: none; }
    
    button.app-button, .plan-card-modal .btn, .account-modal-btn { 
        padding: 14px; 
        background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); 
        border: none; border-radius: 8px; color: var(--button-text-dark); 
        font-size: 1.05rem; font-weight: 600; cursor: pointer; 
        transition: all 0.3s ease; 
        box-shadow: 0 4px 10px color-mix(in srgb, var(--accent-secondary) 20%, transparent);
        display: block; width: 100%; margin-bottom: 18px; box-sizing: border-box; font-family: 'Tajawal', sans-serif;
        text-align: center;
        text-decoration: none;
    }
     .plan-card-modal .btn { 
        font-size: 0.9em;
        padding: 10px 0;
        margin-top: 8px;
        margin-bottom: 0; 
    }
     .account-modal-btn { /* For buttons in create/login/my account modals */
        margin-top: 10px; 
     }


    button.app-button:hover:not(:disabled), .plan-card-modal .btn:hover:not(:disabled), .account-modal-btn:hover:not(:disabled) { 
        background: linear-gradient(90deg, color-mix(in srgb, var(--accent-secondary) 90%, black), color-mix(in srgb, var(--accent-primary) 90%, black)); 
        box-shadow: 0 6px 15px color-mix(in srgb, var(--accent-secondary) 30%, transparent); 
        transform: translateY(-2px); 
    }
    button.app-button:disabled, .plan-card-modal .btn:disabled, .account-modal-btn:disabled { background: var(--bg-tertiary); color: var(--text-tertiary); cursor: not-allowed; box-shadow: none; transform: none;}
    
    .output { background: var(--bg-primary); padding: 18px; border-radius: 8px; min-height: 70px; max-height: 220px; overflow-y: auto; border: 1px solid var(--border-color); font-family: 'Menlo', 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; font-size:0.9em; color: var(--text-secondary); }
    .output.success { color: var(--success-color); border-color: var(--success-color); }
    .output.error { color: var(--error-color); border-color: var(--error-color); }
    .output.info { color: var(--info-color); border-color: var(--info-color); }
    .output.warn { color: var(--warn-color); border-color: var(--warn-color); }
    .footer-prices { text-align: center; margin-top: 25px; font-size: 0.9rem; color: var(--text-tertiary); }
    
    .top-bar { display: flex; justify-content: space-around; align-items: center; background: var(--bg-secondary); padding: 12px; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 5px var(--shadow-color-soft); flex-wrap: wrap; }
    .top-bar button { background: var(--bg-tertiary); border: 1px solid var(--border-color-light); padding: 10px 15px; color: var(--text-primary); cursor: pointer; flex-grow: 1; margin: 5px 6px; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; border-radius: 8px; transition: background-color 0.2s, border-color 0.2s; font-weight: 500;}
    .top-bar button:hover { background: color-mix(in srgb, var(--bg-tertiary) 80%, black); border-color: var(--accent-primary); }
    .top-bar .welcome-message { color: var(--accent-primary); font-weight: 500; margin: 5px 10px; white-space: nowrap;}
    
    .app-modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); padding: 20px; backdrop-filter: blur(4px); font-family: 'Tajawal', sans-serif;}
    .app-modal-overlay.active { display: flex; justify-content: center; align-items: center; } 
    .app-modal-content { background-color: var(--bg-modal); border: 1px solid var(--border-color); margin: 0 auto;  padding: 25px; border-radius: 12px; width: 90%; box-shadow: 0 10px 40px var(--shadow-color-strong); position: relative; color: var(--text-primary); }
    .app-modal-content .close-button { color: var(--text-tertiary); position: absolute; top: 15px; right: 20px; font-size: 2rem; font-weight: bold; transition: color 0.2s; background: none; border: none; cursor: pointer; padding: 0; line-height: 1;}
    .app-modal-content .close-button:hover { color: var(--accent-primary); }
    .app-modal-content h1 { font-size: 1.8em; color: var(--accent-primary); margin-bottom: 25px; text-align: center; font-weight: 700; }

    #licensePlansModal .app-modal-content { max-width: 1100px; }
    .plans-container-modal { display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; gap: 25px; }
    .plan-card-modal { background-color: var(--bg-tertiary); border: 1px solid var(--border-color-light); border-radius: 10px; padding: 20px; width: calc(33.333% - 25px); min-width: 290px; box-shadow: 0 5px 15px var(--shadow-color-soft); display: flex; flex-direction: column; transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease; }
    .plan-card-modal:hover { transform: translateY(-5px); box-shadow: 0 8px 25px color-mix(in srgb, var(--accent-primary) 15%, transparent); border-color: var(--accent-primary); }
    .plan-card-modal h2 { font-size: 1.4em; color: var(--text-primary); margin-top: 0; margin-bottom: 15px; text-align: center; font-weight: 600; }
    .plan-details-modal { list-style: none; padding: 0; margin-bottom: 18px; text-align: left; }
    .plan-details-modal li { margin-bottom: 8px; font-size: 0.9em; color: var(--text-secondary); }
    .plan-details-modal .price { color: var(--accent-primary); font-weight: bold; }
    .plan-actions { margin-top: auto; } 
    .payment-info { display: none; margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-color-light);}
    .btn-buy-modal { /* Covered by .plan-card-modal .btn */ }

    .payment-info h3 { font-size: 1.1em; color: var(--accent-primary); margin-top: 0; margin-bottom: 18px; text-align: center; font-weight: 600; }
    .address-group { margin-bottom: 18px; }
    .address-group label { display: flex; align-items: center; font-size: 0.9em; color: var(--accent-primary); margin-bottom: 6px; font-weight: 500; }
    .address-group label .fa-shield-alt { font-size: 0.9em; color: var(--accent-secondary); opacity: 0.9; transition: color 0.2s ease, opacity 0.2s ease; margin-right: 8px; } 
    .address-group label:hover .fa-shield-alt { color: var(--accent-primary); opacity: 1; }
    .address-line { display: flex; align-items: center; background-color: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color); height: 38px; overflow: hidden; }
    .address-display { background-color: transparent; color: var(--text-secondary); padding: 0 10px; font-family: 'Menlo', 'Courier New', monospace; font-size: 0.85em; border: none; flex-grow: 1; line-height: 38px; height: 38px; white-space: nowrap; overflow-x: auto; }
    .copy-btn { background-color: var(--accent-secondary); color: var(--button-text-dark); padding: 0 15px; font-size: 0.8em; font-weight: 500; border: none; border-left: 1px solid color-mix(in srgb, var(--accent-secondary) 80%, black); cursor: pointer; height: 38px; transition: background-color 0.2s ease-out; display:flex; align-items:center; justify-content:center;}
    .copy-btn:hover { background-color: var(--accent-primary); }
    
    .license-input-group { margin-top: 15px; margin-bottom: 15px; }
    .license-input-group label { font-size: 0.9em; color: var(--accent-primary); margin-bottom: 6px; font-weight: 500;}
    .license-input-group input[type="text"] { margin-bottom: 10px; }

    .license-status { margin-top: 15px; padding: 12px; background-color: var(--bg-primary); border: 1px solid var(--accent-primary); border-radius: 6px; font-size: 0.9em; text-align: center; min-height: 35px; line-height: 1.5; color: var(--accent-primary); }
    
    #settingsModal .app-modal-content, #createAccountModal .app-modal-content, #loginModal .app-modal-content, #myAccountModal .app-modal-content { max-width: 450px; } /* Adjusted width for account modals */
    .settings-section { margin-bottom: 25px; }
    .settings-section h3 { font-size: 1.2em; color: var(--accent-primary); margin-bottom: 15px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 8px; font-weight: 600; }
    
    .settings-option { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 0; gap: 15px; }
    .settings-option > label:not(.toggle-switch) { margin-bottom: 0; color: var(--text-primary); font-size: 1rem; display: flex; align-items: center; font-family: 'Tajawal', sans-serif; flex-grow: 1; flex-shrink: 1; min-width: 0; }
    .settings-option > label:not(.toggle-switch) i { color: var(--text-tertiary); width: 20px; text-align: center; flex-shrink: 0; margin-right: 10px;}
    .settings-option > label:not(.toggle-switch) span[data-lang-key] { flex: 1; min-width: 0; text-align: left; overflow-wrap: break-word; word-break: break-word; }
    .settings-option select, .settings-option input[type="number"], .settings-option > .toggle-switch { margin-bottom: 0; flex-shrink: 0; }
    .settings-option select, .settings-option input[type="number"] { width: auto; min-width: 150px; background-color: var(--bg-secondary); border-color: var(--border-color); font-family: 'Tajawal', sans-serif; }

    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4a4a4a; transition: .4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-primary); }
    input:checked + .slider:before { transform: translateX(24px); }

    #tutorialModal .app-modal-content { max-width: 800px; padding: 20px; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 8px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

    /* Account Modals Specific Styles */
    .form-group { margin-bottom: 15px; }
    .form-group label { font-weight: 500; color: var(--text-secondary); }
    .form-group input[type="text"], .form-group input[type="password"] { 
      margin-bottom: 5px; /* Reduced margin for tighter layout */
    }
    .account-status-modal { /* Common class for status messages in account modals */
        margin-top: 15px; 
        padding: 10px; 
        border-radius: 6px; 
        font-size: 0.9em; 
        text-align: center; 
        min-height: 20px;
        line-height: 1.4;
        display: none; /* Hidden by default */
    }
    .account-status-modal.success { background-color: color-mix(in srgb, var(--success-color) 15%, transparent); color: var(--success-color); border: 1px solid var(--success-color); }
    .account-status-modal.error { background-color: color-mix(in srgb, var(--error-color) 15%, transparent); color: var(--error-color); border: 1px solid var(--error-color); }
    .account-status-modal.info { background-color: color-mix(in srgb, var(--info-color) 15%, transparent); color: var(--info-color); border: 1px solid var(--info-color); }
    
    #myAccountModal .app-modal-content p { font-size: 1.1em; margin-bottom: 20px; text-align: center; }
    #myAccountModal .app-modal-content p strong { color: var(--accent-primary); }


    .web3modal-modal-lightbox { z-index: 10010 !important; backdrop-filter: blur(6px) saturate(150%) !important; background-color: rgba(10, 20, 25, 0.7) !important; font-family: 'Tajawal', sans-serif !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-modal-card {max-width: 400px !important; padding: 28px !important; background: #1c1e22 !important; border-radius: 16px !important; box-shadow: 0 12px 40px rgba(0,0,0,0.5) !important; border: 1px solid #2d3036 !important; font-family: 'Tajawal', sans-serif !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-modal-header {padding-bottom: 20px !important; border-bottom: 1px solid #2d3036 !important; margin-bottom: 20px !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-modal-header h1 {font-size: 1.4em !important; color: #00e5b0 !important; font-weight: 700 !important; text-align: center !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-close-button {top: 20px !important; right: 20px !important; border-radius: 50% !important; width: 32px !important; height: 32px !important; display: flex !important; align-items: center !important; justify-content: center !important; background-color: rgba(255,255,255,0.05) !important; transition: background-color 0.2s ease !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-close-button:hover {background-color: rgba(255,255,255,0.1) !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-close-button svg {width: 14px !important; height: 14px !important; fill: #9098a9 !important; transition: fill 0.2s ease !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-close-button:hover svg {fill: #00e5b0 !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-wrapper {padding: 16px 18px !important; margin-bottom: 12px !important; border: 1px solid #2d3036 !important; background-color: #23252b !important; border-radius: 10px !important; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.15s ease !important; cursor: pointer; display: flex !important; align-items: center !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-wrapper:hover {background-color: #2a2d33 !important; border-color: #00e5b0 !important; transform: scale(1.02) !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-name { font-size: 1.05em !important; color: #eceff4 !important; font-weight: 500 !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-description { font-size: 0.85em !important; color: #a0a8b9 !important; margin-top: 5px !important;}
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-icon { flex-shrink: 0 !important; margin-right: 18px !important;} 
    #WEB3_CONNECT_MODAL_ID .web3modal-provider-icon img {width: 36px !important; height: 36px !important; border-radius: 8px !important; }
    div[id^="walletconnect-qrcode-modal"] .walletconnect-modal__base {background-color: #1c1e22 !important; border-radius: 16px !important; padding: 30px !important; box-shadow: 0 12px 40px rgba(0,0,0,0.6) !important; border: 1px solid #2d3036 !important; max-width: 380px !important; font-family: 'Tajawal', sans-serif !important;} 
    div[id^="walletconnect-qrcode-modal"] h2 { color: #00e5b0 !important; font-family: 'Tajawal', sans-serif !important; font-size: 1.3em !important; margin-bottom: 20px !important;}
    div[id^="walletconnect-qrcode-modal"] .walletconnect-qrcode__text {color: #a0a8b9 !important; font-family: 'Tajawal', sans-serif !important; font-size: 0.95em !important;}
    div[id^="walletconnect-qrcode-modal"] .walletconnect-qrcode__image {border: 6px solid #2d3036 !important; border-radius: 12px !important; padding: 10px !important; background-color: #fff !important; }
  </style>
</head>
<body>
  <div class="top-bar">
    <button id="buy-license-btn" data-lang-key="buyLicenseBtnTop">Buy Licence Code</button>
    <button id="connect-wallet-btn" data-lang-key="connectWalletBtnTop">Connect Wallet</button>
    <button id="settings-btn-main" data-lang-key="settingsBtnTop">Settings</button>
    <button id="tutorial-btn-top" data-lang-key="tutorialBtnTop">Tutorial</button> 
    
    <!-- Account related buttons - visibility managed by JS -->
    <span id="welcome-user-span" class="welcome-message" style="display: none;"></span>
    <button id="create-account-btn-top" data-lang-key="createAccountBtnTop">Create Account</button>
    <button id="login-btn-top" data-lang-key="loginBtnTop">Login</button>
    <button id="my-account-btn-top" data-lang-key="myAccountBtnTop" style="display: none;">My Account</button>
    <button id="logout-btn-top" data-lang-key="logoutBtnTop" style="display: none;">Logout</button>
  </div>

  <div class="container">
    <h1 data-lang-key="mainTitle">SIGMA CRYPTO FLASH SENDER v1.5.4</h1>
    <label for="crypto-select" data-lang-key="selectCryptoLabel">Select Crypto:</label>
    <select id="crypto-select">
      <option value="USDT">USDT</option>
      <option value="BTC">BTC</option> 
      <option value="ETH">ETH</option>
    </select>
    <label for="wallet-address" id="wallet-address-label" data-lang-key="walletAddressLabel">Enter your Wallet address here:</label>
    <input type="text" id="wallet-address" placeholder="Wallet Address">
    <button id="validate-address-btn" class="app-button"><span data-lang-key="validateBtn">Validate</span> <span id="validate-crypto-name">USDT</span> <span data-lang-key="addressWord">Address</span></button>
    <label for="amount" data-lang-key="amountLabel">Amount:</label>
    <input type="number" id="amount" placeholder="Enter amount">
    <label for="network-select" data-lang-key="networkLabel">Select Network:</label>
    <select id="network-select">
    </select>
    <label for="proxy-settings" data-lang-key="proxyLabel">Proxy Settings:</label>
    <select id="proxy-settings">
      <option value="no-proxy" data-lang-key="proxyNo">Don't Use Proxy</option>
      <option value="use-proxy" data-lang-key="proxyUse">Use Proxy</option>
    </select>
    <button id="create-transaction-btn" class="app-button" data-lang-key="createTransactionBtn" disabled>Create Transaction</button>
    <div id="output-console" class="output" data-lang-key="outputConsolePlaceholder">Transaction output will appear here.</div>
  </div>

  <div class="footer-prices">
    TH: <span id="th-price">N/A</span> |
    USDT: <span id="usdt-price">$0.00</span> |
    BNB: <span id="bnb-price">$0.00</span> |
    TRON: <span id="tron-price">$0.0000</span> 
  </div>

  <div id="licensePlansModal" class="app-modal-overlay">
    <div class="app-modal-content">
      <button class="close-button" id="closeLicenseModalBtn">×</button>
      <h1 data-lang-key="licensePlansTitle">License Plans</h1>
      <div class="plans-container-modal">
        <!-- Master Plan Card -->
        <div class="plan-card-modal">
            <div>
                <h2 data-lang-key="masterPlanTitle">Master</h2>
                <ul class="plan-details-modal">
                    <li data-lang-key="masterPlanDetail1">1 day <span class='price'>$200</span> - 950k Flash Limit</li>
                    <li data-lang-key="masterPlanDetail2">7 days <span class='price'>$350</span> - 30M Flash Limit</li>
                    <li data-lang-key="masterPlanDetail3">1 month <span class='price'>$750</span> - 500M Flash Limit</li>
                </ul>
            </div>
            <div class="plan-actions">
                <a href="#" class="btn btn-buy-modal" data-lang-key="buyNowBtn">BUY NOW</a>
            </div>
            <div class="payment-info">
                <h3 data-lang-key="payForMasterPlan">Pay for Master Plan</h3>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (TRC20):</label>
                    <div class="address-line"><span class="address-display" id="master-trc20-addr">TPowMg7Jd3DpwDggkoSzxuTU8pGTksdua8</span><button class="copy-btn" data-copytarget="master-trc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (ERC20):</label>
                    <div class="address-line"><span class="address-display" id="master-erc20-addr">0x374756d81ccc0f8cad4e0863bb96ad5e1579f9cc</span><button class="copy-btn" data-copytarget="master-erc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                <div class="license-input-group">
                    <label for="license-key-master" data-lang-key="enterLicenseKeyLabel">Enter License Key:</label>
                    <input type="text" id="license-key-master" placeholder="XXX-XXX-XXX-XXX" maxlength="20">
                    <button class="btn btn-activate-license" data-lang-key="activateLicenseBtn">Activate License</button>
                </div>
                <div class="license-status" style="display: none;"></div>
                <button class="btn btn-back-to-plans-after-status" style="display:none;" data-lang-key="backToPlansBtn">Back to Plans</button>
            </div>
        </div>
        <!-- Basic Plan Card -->
        <div class="plan-card-modal">
            <div>
                <h2 data-lang-key="basicPlanTitle">Basic</h2>
                <ul class="plan-details-modal">
                    <li data-lang-key="basicPlanDetail1">1D <span class='price'>$100</span> - Limited to 2k flash</li>
                    <li data-lang-key="basicPlanDetail2">7D <span class='price'>$150</span> - Limited to 20k flash</li>
                    <li data-lang-key="basicPlanDetail3">1MO <span class='price'>$300</span> - Limited to 200k flash</li>
                </ul>
            </div>
            <div class="plan-actions">
                <a href="#" class="btn btn-buy-modal" data-lang-key="buyNowBtn">BUY NOW</a>
            </div>
            <div class="payment-info">
                <h3 data-lang-key="payForBasicPlan">Pay for Basic Plan</h3>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (TRC20):</label>
                    <div class="address-line"><span class="address-display" id="basic-trc20-addr">TPowMg7Jd3DpwDggkoSzxuTU8pGTksdua8</span><button class="copy-btn" data-copytarget="basic-trc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (ERC20):</label>
                    <div class="address-line"><span class="address-display" id="basic-erc20-addr">0x374756d81ccc0f8cad4e0863bb96ad5e1579f9cc</span><button class="copy-btn" data-copytarget="basic-erc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                 <div class="license-input-group">
                    <label for="license-key-basic" data-lang-key="enterLicenseKeyLabel">Enter License Key:</label>
                    <input type="text" id="license-key-basic" placeholder="XXX-XXX-XXX-XXX" maxlength="20">
                    <button class="btn btn-activate-license" data-lang-key="activateLicenseBtn">Activate License</button>
                </div>
                <div class="license-status" style="display: none;"></div>
                <button class="btn btn-back-to-plans-after-status" style="display:none;" data-lang-key="backToPlansBtn">Back to Plans</button>
            </div>
        </div>
        <!-- Infinity Plan Card -->
        <div class="plan-card-modal">
            <div>
                <h2 data-lang-key="infinityPlanTitle">Infinity</h2>
                <ul class="plan-details-modal">
                    <li data-lang-key="infinityPlanDetail1">1D <span class='price'>$150</span> - Limited to 35k flash</li>
                    <li data-lang-key="infinityPlanDetail2">7D <span class='price'>$250</span> - Limited to 350k flash</li>
                    <li data-lang-key="infinityPlanDetail3">1MO <span class='price'>$500</span> - Limited to 750k flash</li>
                </ul>
            </div>
            <div class="plan-actions">
                <a href="#" class="btn btn-buy-modal" data-lang-key="buyNowBtn">BUY NOW</a>
            </div>
            <div class="payment-info">
                <h3 data-lang-key="payForInfinityPlan">Pay for Infinity Plan</h3>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (TRC20):</label>
                    <div class="address-line"><span class="address-display" id="infinity-trc20-addr">TPowMg7Jd3DpwDggkoSzxuTU8pGTksdua8</span><button class="copy-btn" data-copytarget="infinity-trc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                <div class="address-group">
                    <label><i class="fas fa-shield-alt"></i> USDT (ERC20):</label>
                    <div class="address-line"><span class="address-display" id="infinity-erc20-addr">0x374756d81ccc0f8cad4e0863bb96ad5e1579f9cc</span><button class="copy-btn" data-copytarget="infinity-erc20-addr" data-lang-key="copyBtn">Copy</button></div>
                </div>
                <div class="license-input-group">
                    <label for="license-key-infinity" data-lang-key="enterLicenseKeyLabel">Enter License Key:</label>
                    <input type="text" id="license-key-infinity" placeholder="XXX-XXX-XXX-XXX" maxlength="20">
                    <button class="btn btn-activate-license" data-lang-key="activateLicenseBtn">Activate License</button>
                </div>
                <div class="license-status" style="display: none;"></div>
                <button class="btn btn-back-to-plans-after-status" style="display:none;" data-lang-key="backToPlansBtn">Back to Plans</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="app-modal-overlay">
    <div class="app-modal-content">
        <button class="close-button" id="closeSettingsModalBtn">×</button>
        <h1 data-lang-key="settingsTitle">Settings</h1>

        <div class="settings-section">
            <h3 data-lang-key="appearanceSettings">Appearance</h3>
            <div class="settings-option">
                <label for="languageSelect"><i class="fas fa-language"></i> <span data-lang-key="languageLabel">Language</span></label>
                <select id="languageSelect">
                    <option value="en">English</option>
                    <!-- <option value="ar">العربية</option> -->
                </select>
            </div>
            <div class="settings-option">
                <label for="themeToggle"><i class="fas fa-palette"></i> <span data-lang-key="themeLabel">Theme</span></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section">
            <h3 data-lang-key="flashSettings">Flash Loan Properties</h3>
            <div class="settings-option">
                <label for="flashDuration"><i class="fas fa-clock"></i> <span data-lang-key="flashDurationLabel">Flash Duration (Blocks)</span></label>
                <input type="number" id="flashDuration" value="1" min="1" max="10">
            </div>
            <div class="settings-option">
                <label for="transferableToggle"><i class="fas fa-exchange-alt"></i> <span data-lang-key="transferableLabel">Transferable</span></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="transferableToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <label for="tradableToggle"><i class="fas fa-chart-line"></i> <span data-lang-key="tradableLabel">Tradable</span></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="tradableToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <label for="divisibleToggle"><i class="fas fa-divide"></i> <span data-lang-key="divisibleLabel">Divisible</span></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="divisibleToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <button id="saveSettingsBtn" class="app-button" data-lang-key="saveSettingsBtn" style="margin-top: 20px;">Save Settings</button>
    </div>
  </div>

  <!-- Tutorial Modal -->
  <div id="tutorialModal" class="app-modal-overlay">
    <div class="app-modal-content">
        <button class="close-button" id="closeTutorialModalBtn">×</button>
        <h1 data-lang-key="tutorialModalTitle">How to Use</h1>
        <div class="video-container">
            <iframe 
                src="https://www.youtube.com/embed/VIDEO_ID_HERE" 
                title="YouTube video player" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                allowfullscreen>
            </iframe>
        </div>
    </div>
  </div>

  <!-- Create Account Modal -->
  <div id="createAccountModal" class="app-modal-overlay">
    <div class="app-modal-content">
        <button class="close-button" id="closeCreateAccountModalBtn">×</button>
        <h1 data-lang-key="createAccountModalTitle">Create New Account</h1>
        <div class="form-group">
            <label for="username-input-modal" data-lang-key="usernameLabel">Username:</label>
            <input type="text" id="username-input-modal" placeholder="Enter a username">
        </div>
        <div class="form-group">
            <label for="password-input-modal" data-lang-key="passwordLabel">Password:</label>
            <input type="password" id="password-input-modal" placeholder="Enter a password">
        </div>
        <button id="submit-create-account-btn-modal" class="account-modal-btn" data-lang-key="createAccountModalBtn">Create Account</button>
        <div id="account-creation-status-modal" class="account-status-modal"></div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="app-modal-overlay">
    <div class="app-modal-content">
        <button class="close-button" id="closeLoginModalBtn">×</button>
        <h1 data-lang-key="loginModalTitle">Login to Your Account</h1>
        <div class="form-group">
            <label for="username-input-login-modal" data-lang-key="usernameLabel">Username:</label>
            <input type="text" id="username-input-login-modal" placeholder="Enter your username">
        </div>
        <div class="form-group">
            <label for="password-input-login-modal" data-lang-key="passwordLabel">Password:</label>
            <input type="password" id="password-input-login-modal" placeholder="Enter your password">
        </div>
        <button id="submit-login-btn-modal" class="account-modal-btn" data-lang-key="loginModalBtn">Login</button>
        <div id="login-status-modal" class="account-status-modal"></div>
    </div>
  </div>

  <!-- My Account Modal -->
  <div id="myAccountModal" class="app-modal-overlay">
    <div class="app-modal-content">
        <button class="close-button" id="closeMyAccountModalBtn">×</button>
        <h1 data-lang-key="myAccountModalTitle">My Account</h1>
        <p><span data-lang-key="loggedInAsLabel">Logged in as:</span> <strong id="my-account-username-display"></strong></p>
        <p data-lang-key="myAccountInfoPlaceholder">Your account details and history would appear here.</p>
        <button id="logout-btn-myaccount-modal" class="account-modal-btn" data-lang-key="logoutBtn">Logout</button>
    </div>
  </div>


  <script>
    // ===================================================================================
    const WALLETCONNECT_PROJECT_ID = 'DUMMY_PROJECT_ID_REPLACE_ME_LATER_123'; 
    const validLicenseKeys = ["A9#K-X7L@-2M!P-R4$Z", "Q%8W-M1#T-Z$3N-J@6K", "B@7L-R#5X-9Z!Q-F$1M"];
    // ===================================================================================
    let web3ModalInstance; let ethersProvider; let signer; let connectedAddress = null; let rawProviderInstance;
    let isLicenseActive = false; 
    let createdAccounts = []; // Internal storage for created accounts
    let currentUser = null; // Tracks the currently "logged-in" user
    
    const defaultSettings = { language: 'en', theme: 'dark', flashDuration: 1, isTransferable: true, isTradable: false, isDivisible: true };
    let currentSettings = { ...defaultSettings }; 

    const translations = {
        en: {
            mainTitle: "SIGMA FLASH USDT GENERATOR v1.5.4", selectCryptoLabel: "Select Crypto:", walletAddressLabel: "Enter your Wallet address here:", validateBtn: "Validate", addressWord: "Address", amountLabel: "Amount:", networkLabel: "Select Network:", proxyLabel: "Proxy Settings:", proxyNo: "Don't Use Proxy", proxyUse: "Use Proxy", createTransactionBtn: "Create Transaction", outputConsolePlaceholder: "Transaction output will appear here.",
            licensePlansTitle: "License Plans",
            masterPlanTitle: "Master", masterPlanDetail1: "1 day <span class='price'>$200</span> - 950k Flash Limit", masterPlanDetail2: "7 days <span class='price'>$350</span> - 30M Flash Limit", masterPlanDetail3: "1 month <span class='price'>$750</span> - 500M Flash Limit",
            basicPlanTitle: "Basic", basicPlanDetail1: "1D <span class='price'>$100</span> - Limited to 2k flash", basicPlanDetail2: "7D <span class='price'>$150</span> - Limited to 20k flash", basicPlanDetail3: "1MO <span class='price'>$300</span> - Limited to 200k flash",
            infinityPlanTitle: "Infinity", infinityPlanDetail1: "1D <span class='price'>$150</span> - Limited to 35k flash", infinityPlanDetail2: "7D <span class='price'>$250</span> - Limited to 350k flash", infinityPlanDetail3: "1MO <span class='price'>$500</span> - Limited to 750k flash",
            buyNowBtn: "BUY NOW", copyBtn: "Copy",
            payForMasterPlan: "Pay for Master Plan", payForBasicPlan: "Pay for Basic Plan", payForInfinityPlan: "Pay for Infinity Plan",
            enterLicenseKeyLabel: "Enter License Key:", activateLicenseBtn: "Activate License",
            licenseStatusVerifying: "Verifying license...", licenseStatusSuccess: "License activated successfully! You can now create transactions.", licenseStatusError: "Invalid or expired license key. Transaction creation disabled.",
            activateLicenseFirst: "Please activate a license first to create a transaction. You can do this from the 'Buy Licence Code' section.",
            backToPlansBtn: "Back to Plans",
            settingsTitle: "Settings", appearanceSettings: "Appearance", languageLabel: "Language", themeLabel: "Theme", flashSettings: "Flash Loan Properties", flashDurationLabel: "Flash Duration (Blocks)", transferableLabel: "Transferable", tradableLabel: "Tradable", divisibleLabel: "Divisible", saveSettingsBtn: "Save Settings",
            connectWalletBtnTop: "Connect Wallet", connectWalletBtnTitle: "Connect your crypto wallet", buyLicenseBtnTop: "Buy Licence Code", 
            createAccountBtnTop: "Create Account", loginBtnTop: "Login", myAccountBtnTop: "My Account", logoutBtnTop: "Logout",
            settingsBtnTop: "Settings", tutorialBtnTop: "Tutorial",
            walletAddressPlaceholder: "Wallet Address", amountPlaceholder: "Enter amount",
            copied: "Copied!",
            enterLicenseKeyAlert: "Please enter a license key.",
            tutorialModalTitle: "How to Use",
            createAccountModalTitle: "Create New Account", usernameLabel: "Username:", passwordLabel: "Password:", createAccountModalBtn: "Create Account",
            accountCreatedSuccess: "Account created successfully! You are now logged in.",
            usernameTakenError: "Username already taken. Please choose another.",
            fillAllFieldsError: "Please fill in all fields.",
            accountFeatureInfo: "Account creation & login are stored in memory (lost on refresh).",
            loginModalTitle: "Login to Your Account", loginModalBtn: "Login",
            loginFailedError: "Invalid username or password.",
            loginSuccess: "Login successful!",
            myAccountModalTitle: "My Account", loggedInAsLabel: "Logged in as:", myAccountInfoPlaceholder: "Your account details and transaction history would appear here.",
            logoutBtn: "Logout", // Generic logout button text
            loggedOutSuccess: "You have been logged out."
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const cryptoSelect = document.getElementById('crypto-select'); 
      const walletAddressInput = document.getElementById('wallet-address'); 
      const validateAddressBtn = document.getElementById('validate-address-btn'); 
      const validateCryptoNameSpan = document.getElementById('validate-crypto-name'); 
      const amountInput = document.getElementById('amount'); 
      const networkSelectEl = document.getElementById('network-select'); 
      const createTransactionBtn = document.getElementById('create-transaction-btn'); 
      const outputConsoleElem = document.getElementById('output-console'); 
      const licenseModal = document.getElementById('licensePlansModal'); 
      const buyLicenseBtn = document.getElementById('buy-license-btn'); 
      const closeLicenseModalBtn = document.getElementById('closeLicenseModalBtn'); 
      const connectWalletBtn = document.getElementById('connect-wallet-btn');
      
      // Top Bar Account Buttons
      const createAccountBtnTop = document.getElementById('create-account-btn-top');
      const loginBtnTop = document.getElementById('login-btn-top');
      const myAccountBtnTop = document.getElementById('my-account-btn-top');
      const logoutBtnTop = document.getElementById('logout-btn-top');
      const welcomeUserSpan = document.getElementById('welcome-user-span');


      const settingsBtnMain = document.getElementById('settings-btn-main');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
      const languageSelect = document.getElementById('languageSelect');
      const themeToggle = document.getElementById('themeToggle');
      const flashDurationInput = document.getElementById('flashDuration');
      const transferableToggle = document.getElementById('transferableToggle');
      const tradableToggle = document.getElementById('tradableToggle');
      const divisibleToggle = document.getElementById('divisibleToggle');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');

      const tutorialBtnTop = document.getElementById('tutorial-btn-top');
      const tutorialModal = document.getElementById('tutorialModal');
      const closeTutorialModalBtn = document.getElementById('closeTutorialModalBtn');
      const tutorialVideoIframe = tutorialModal.querySelector('iframe');
      const originalTutorialVideoSrc = tutorialVideoIframe ? tutorialVideoIframe.src : "";

      // Create Account Modal Elements
      const createAccountModal = document.getElementById('createAccountModal');
      const closeCreateAccountModalBtn = document.getElementById('closeCreateAccountModalBtn');
      const usernameInputModal = document.getElementById('username-input-modal');
      const passwordInputModal = document.getElementById('password-input-modal');
      const submitCreateAccountBtnModal = document.getElementById('submit-create-account-btn-modal');
      const accountCreationStatusModal = document.getElementById('account-creation-status-modal');

      // Login Modal Elements
      const loginModal = document.getElementById('loginModal');
      const closeLoginModalBtn = document.getElementById('closeLoginModalBtn');
      const usernameInputLoginModal = document.getElementById('username-input-login-modal');
      const passwordInputLoginModal = document.getElementById('password-input-login-modal');
      const submitLoginBtnModal = document.getElementById('submit-login-btn-modal');
      const loginStatusModal = document.getElementById('login-status-modal');

      // My Account Modal Elements
      const myAccountModal = document.getElementById('myAccountModal');
      const closeMyAccountModalBtn = document.getElementById('closeMyAccountModalBtn');
      const myAccountUsernameDisplay = document.getElementById('my-account-username-display');
      const logoutBtnMyAccountModal = document.getElementById('logout-btn-myaccount-modal');


      function logToAppConsole(message, type = 'info') { 
          const timestamp = new Date().toLocaleTimeString(); 
          const logMessage = `\n[${timestamp}] ${message}`; 
          if (outputConsoleElem) { 
              if (outputConsoleElem.dataset.hasContent === "false" || !outputConsoleElem.dataset.hasContent) {
                  outputConsoleElem.textContent = ""; 
                  outputConsoleElem.dataset.hasContent = "true"; 
              }
              outputConsoleElem.textContent += logMessage; 
              outputConsoleElem.scrollTop = outputConsoleElem.scrollHeight; 
              outputConsoleElem.className = 'output ' + type; 
          } 
          switch(type) { 
              case 'error': console.error(`[App UI] ${message}`); break; 
              case 'warn': console.warn(`[App UI] ${message}`); break; 
              default: console.log(`[App UI] ${message}`); 
          } 
      }
      
      function updateCreateTransactionButtonState() {
        if (createTransactionBtn) {
            createTransactionBtn.disabled = !isLicenseActive;
        }
      }
      
      function updateTopBarForLoginState() {
          const lang = 'en';
          if (currentUser) {
              welcomeUserSpan.textContent = `Welcome, ${currentUser.username}!`;
              welcomeUserSpan.style.display = 'inline';
              createAccountBtnTop.style.display = 'none';
              loginBtnTop.style.display = 'none';
              myAccountBtnTop.style.display = 'inline-block'; // or 'flex' if it's a flex item
              logoutBtnTop.style.display = 'inline-block';
          } else {
              welcomeUserSpan.style.display = 'none';
              createAccountBtnTop.style.display = 'inline-block';
              loginBtnTop.style.display = 'inline-block';
              myAccountBtnTop.style.display = 'none';
              logoutBtnTop.style.display = 'none';
          }
      }


      function applyTranslations() { 
          const lang = 'en'; 
          document.documentElement.lang = lang;
          document.documentElement.dir = 'ltr'; 
          
          document.querySelectorAll('[data-lang-key]').forEach(element => {
              const key = element.getAttribute('data-lang-key');
              const translationText = translations[lang]?.[key]; 

              if (translationText) {
                  if (element.tagName === 'INPUT' && element.placeholder) {
                      const placeholderKeyId = element.id + "Placeholder";
                      const placeholderKeyGeneric = key + "Placeholder";
                      if (translations[lang]?.[placeholderKeyId]) {
                          element.placeholder = translations[lang][placeholderKeyId];
                      } else if (translations[lang]?.[placeholderKeyGeneric]) {
                           element.placeholder = translations[lang][placeholderKeyGeneric];
                      } else if (element.id === 'username-input-modal' || element.id === 'username-input-login-modal') {
                           element.placeholder = "Enter username"; 
                      } else if (element.id === 'password-input-modal' || element.id === 'password-input-login-modal') {
                           element.placeholder = "Enter password";
                      }
                       else {
                           element.placeholder = ""; 
                      }
                  } else if (element.tagName === 'DIV' && element.classList.contains('output') && key === 'outputConsolePlaceholder') {
                      if (element.dataset.hasContent === "false" || !element.dataset.hasContent) { 
                          element.textContent = translationText;
                          element.dataset.hasContent = "false";
                      }
                  } else if (element.tagName === 'BUTTON' && element.classList.contains('copy-btn') && key === 'copyBtn') {
                        if (element.textContent !== translations[lang]?.copied ) { 
                           element.textContent = translationText;
                        }
                  } else if (element.tagName === 'LI' && (key.includes('PlanDetail'))) { 
                        element.innerHTML = translationText; 
                  } else if (element.id === 'welcome-user-span' && currentUser) {
                        // handled by updateTopBarForLoginState
                  }
                  else {
                      element.textContent = translationText;
                  }
              }
          });
            if (usernameInputModal && !usernameInputModal.placeholder) usernameInputModal.placeholder = "Enter a username";
            if (passwordInputModal && !passwordInputModal.placeholder) passwordInputModal.placeholder = "Enter a password";
            if (usernameInputLoginModal && !usernameInputLoginModal.placeholder) usernameInputLoginModal.placeholder = "Enter your username";
            if (passwordInputLoginModal && !passwordInputLoginModal.placeholder) passwordInputLoginModal.placeholder = "Enter your password";


          if (connectWalletBtn && !connectedAddress) {
            connectWalletBtn.title = translations[lang]?.connectWalletBtnTitle;
          }
          document.querySelectorAll('.btn-activate-license').forEach(btn => {
                const verifyingText = translations[lang]?.licenseStatusVerifying;
                const activateText = translations[lang]?.activateLicenseBtn;

                if (btn.disabled && btn.textContent === verifyingText) {
                } else if (!btn.disabled) {
                     btn.textContent = activateText;
                }
            });
           if (outputConsoleElem && (outputConsoleElem.dataset.hasContent === "false" || !outputConsoleElem.dataset.hasContent)) {
                outputConsoleElem.textContent = translations[lang]?.outputConsolePlaceholder;
           }
           updateTopBarForLoginState(); // Ensure top bar reflects login state after translations
      }
      
      function applyTheme(theme) {
          if (theme === 'light') {
              document.body.classList.add('light-theme');
          } else {
              document.body.classList.remove('light-theme');
          }
          if(themeToggle) themeToggle.checked = (theme === 'light');
          if(web3ModalInstance && typeof web3ModalInstance.updateTheme === 'function') {
              web3ModalInstance.updateTheme(theme);
          }
      }
      
      function loadSettings() {
          const savedSettingsString = localStorage.getItem('sigmaFlashSettings');
          if (savedSettingsString) {
              try {
                  const savedSettingsObject = JSON.parse(savedSettingsString);
                  currentSettings.theme = savedSettingsObject.theme || defaultSettings.theme;
                  currentSettings.flashDuration = savedSettingsObject.flashDuration || defaultSettings.flashDuration;
                  currentSettings.isTransferable = typeof savedSettingsObject.isTransferable === 'boolean' ? savedSettingsObject.isTransferable : defaultSettings.isTransferable;
                  currentSettings.isTradable = typeof savedSettingsObject.isTradable === 'boolean' ? savedSettingsObject.isTradable : defaultSettings.isTradable;
                  currentSettings.isDivisible = typeof savedSettingsObject.isDivisible === 'boolean' ? savedSettingsObject.isDivisible : defaultSettings.isDivisible;

              } catch (e) {
                  console.error("Error parsing settings from localStorage:", e);
                  currentSettings = { ...defaultSettings }; 
              }
          } else {
             currentSettings = { ...defaultSettings }; 
          }
          currentSettings.language = 'en';
          if(languageSelect) languageSelect.value = currentSettings.language; 

          if(flashDurationInput) flashDurationInput.value = currentSettings.flashDuration;
          if(transferableToggle) transferableToggle.checked = currentSettings.isTransferable;
          if(tradableToggle) tradableToggle.checked = currentSettings.isTradable;
          if(divisibleToggle) divisibleToggle.checked = currentSettings.isDivisible;
          
          applyTheme(currentSettings.theme); 
          applyTranslations(); 
      }
      
      function saveAndApplySettings() {
          currentSettings.theme = themeToggle.checked ? 'light' : 'dark';
          currentSettings.flashDuration = parseInt(flashDurationInput.value) || 1;
          if (currentSettings.flashDuration < 1) currentSettings.flashDuration = 1;
          if (currentSettings.flashDuration > 10) currentSettings.flashDuration = 10;
          flashDurationInput.value = currentSettings.flashDuration; 

          currentSettings.isTransferable = transferableToggle.checked;
          currentSettings.isTradable = tradableToggle.checked;
          currentSettings.isDivisible = divisibleToggle.checked;
          
          const settingsToSave = {
              theme: currentSettings.theme,
              flashDuration: currentSettings.flashDuration,
              isTransferable: currentSettings.isTransferable,
              isTradable: currentSettings.isTradable,
              isDivisible: currentSettings.isDivisible
          };
          localStorage.setItem('sigmaFlashSettings', JSON.stringify(settingsToSave));
          
          applyTheme(currentSettings.theme);
          applyTranslations(); 
          updateUIForCrypto(); 
          
          logToAppConsole("Settings saved and applied!", "success");
          if(settingsModal) settingsModal.style.display="none";
      }

      function initWeb3Modal() { console.log("Initializing Web3Modal for EVM Wallets..."); if (typeof window.ethers === "undefined" || typeof window.Web3Modal === "undefined") { logToAppConsole("Ethers.js or Web3Modal library not loaded. Wallet connection unavailable.", "error"); if (connectWalletBtn) connectWalletBtn.disabled = true; return; } if (typeof window.WalletConnectProvider === "undefined") { logToAppConsole("WalletConnectProvider library not loaded. WalletConnect QR option may be limited.", "warn"); } if (WALLETCONNECT_PROJECT_ID === 'DUMMY_PROJECT_ID_REPLACE_ME_LATER_123' && typeof window.WalletConnectProvider !== "undefined") { logToAppConsole("WARNING: Using a DUMMY WalletConnect Project ID. WalletConnect QR/Mobile connections will likely FAIL. Please replace it with your real Project ID for full functionality.", "warn"); } const providerOptions = { walletconnect: (typeof window.WalletConnectProvider !== "undefined") ? { package: window.WalletConnectProvider.default, options: { projectId: WALLETCONNECT_PROJECT_ID, rpc: { 1: "https://cloudflare-eth.com", 56: "https://bsc-dataseed.binance.org/", 137: "https://polygon-rpc.com/", }, } } : undefined }; for (const key in providerOptions) { if (providerOptions[key] === undefined) { delete providerOptions[key]; } } try { web3ModalInstance = new window.Web3Modal.default({ cacheProvider: true, providerOptions, theme: currentSettings.theme, disableInjectedProvider: false, }); console.log("Web3Modal instance created."); if (web3ModalInstance.cachedProvider) { logToAppConsole("Attempting to connect to cached EVM provider...", "info"); connectActiveWallet(); } } catch (e) { logToAppConsole(`Error initializing Web3Modal: ${e.message}`, "error"); console.error("Web3Modal Init Error:", e); if (connectWalletBtn) connectWalletBtn.disabled = true; } }
      async function connectActiveWallet() { if (!web3ModalInstance) { initWeb3Modal(); if(!web3ModalInstance) {logToAppConsole("Web3Modal could not be initialized.", "error"); return;} } web3ModalInstance.updateTheme(currentSettings.theme); logToAppConsole("Opening wallet selection modal (or connecting to cached)...", "info"); try { rawProviderInstance = await web3ModalInstance.connect(); attachProviderEvents(rawProviderInstance); ethersProvider = new window.ethers.providers.Web3Provider(rawProviderInstance); signer = ethersProvider.getSigner(); connectedAddress = await signer.getAddress(); const network = await ethersProvider.getNetwork(); updateWalletButton(true, connectedAddress, network.name); logToAppConsole(`EVM Wallet connected: ${connectedAddress} on ${network.name} (Chain ID: ${network.chainId})`, "success"); populateAddressIfApplicable(connectedAddress); } catch (error) { if (error.message && error.message.toLowerCase().includes("user closed modal")) { logToAppConsole("Wallet connection modal closed by user.", "info"); } else if (error.message && error.message.toLowerCase().includes("failed to connect to wc bridge") && WALLETCONNECT_PROJECT_ID === 'DUMMY_PROJECT_ID_REPLACE_ME_LATER_123'){ logToAppConsole("WalletConnect bridge connection failed (likely DUMMY Project ID).", "error"); } else if (error.message && error.message.toLowerCase().includes("provider already selected")){ if(web3ModalInstance) web3ModalInstance.clearCachedProvider(); logToAppConsole("Connection issue with cached provider. Cleared cache. Please try connecting again.", "warn"); } else { logToAppConsole(`Could not connect to wallet: ${error.message || error}`, "error"); console.error("Connect Wallet Error:", error); } await disconnectActiveWallet(false); } }
      async function disconnectActiveWallet(showMessage = true) { if (showMessage) logToAppConsole("Disconnecting EVM wallet...", "info"); if (rawProviderInstance && typeof rawProviderInstance.close === 'function') { try { await rawProviderInstance.close(); } catch (e) { console.warn("Error closing provider session:", e); } } if (web3ModalInstance) { await web3ModalInstance.clearCachedProvider(); } removeProviderEvents(rawProviderInstance); rawProviderInstance = null; ethersProvider = null; signer = null; connectedAddress = null; updateWalletButton(false); if (showMessage) logToAppConsole("EVM Wallet disconnected.", "info"); }
      function attachProviderEvents(provider) { if (!provider) return; provider.on("accountsChanged", handleAccountsChanged); provider.on("chainChanged", handleChainChanged); provider.on("disconnect", handleDisconnect); }
      function removeProviderEvents(provider) { if (!provider) return; provider.removeListener("accountsChanged", handleAccountsChanged); provider.removeListener("chainChanged", handleChainChanged); provider.removeListener("disconnect", handleDisconnect); }
      function handleAccountsChanged(accounts) { logToAppConsole(`EVM Wallet accounts changed. New accounts: ${JSON.stringify(accounts)}`, "info"); if (accounts.length === 0) { logToAppConsole("All accounts disconnected by user action in wallet.", "warn"); disconnectActiveWallet(); } else if (accounts[0] !== connectedAddress) { connectedAddress = accounts[0]; if(ethersProvider) signer = ethersProvider.getSigner(); logToAppConsole(`Switched to account: ${connectedAddress}`, "info"); ethersProvider.getNetwork().then(network => { updateWalletButton(true, connectedAddress, network.name); }).catch(() => updateWalletButton(true, connectedAddress, "Unknown EVM Network")); populateAddressIfApplicable(connectedAddress); } }
      function handleChainChanged(chainIdHex) { const chainId = parseInt(chainIdHex, 16); logToAppConsole(`EVM Wallet network changed to Chain ID: ${chainId}. Wallet disconnected.`, "warn"); disconnectActiveWallet(false); alert(`Network changed to Chain ID ${chainId}. Wallet disconnected. Please reconnect if you wish to continue on this network.`); updateWalletButton(false); }
      function handleDisconnect(error) { logToAppConsole(`EVM Wallet disconnected by provider. Error: ${error ? (error.message || error) : 'N/A'}`, "warn"); disconnectActiveWallet(false); }
      
      function updateWalletButton(isConnected, address = null, networkName = null) {
          if (!connectWalletBtn) return;
          const lang = 'en'; 
          if (isConnected && address) {
              const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
              connectWalletBtn.textContent = networkName ? `${shortAddress} (${networkName})` : shortAddress;
              connectWalletBtn.title = `Connected: ${address}${networkName ? ' on ' + networkName : ''}. Click to disconnect.`; 
              connectWalletBtn.onclick = disconnectActiveWallet;
          } else {
              connectWalletBtn.title = translations[lang]?.connectWalletBtnTitle;
              connectWalletBtn.onclick = connectActiveWallet;
              connectWalletBtn.textContent = translations[lang]?.connectWalletBtnTop;
          }
      }
      
      function populateAddressIfApplicable(currentAddr) {  if ((cryptoSelect.value === 'ETH' || cryptoSelect.value === 'USDT') && currentAddr) { if (!walletAddressInput.value || walletAddressInput.value !== currentAddr) { walletAddressInput.value = currentAddr; logToAppConsole(`Wallet address ${currentAddr} populated into the input field.`, "info"); } } else if (walletAddressInput.value === currentAddr) { walletAddressInput.value = ''; } }
      
      const cryptoConfig = { 'USDT': { label: 'USDT', networks: ['USDT (ERC20)', 'USDT (TRC20)'], addressPlaceholderKey: 'walletAddressPlaceholder', coinGeckoId: 'tether'}, 'BTC': { label: 'BTC', networks: ['Bitcoin (Simulation Only)'], addressPlaceholderKey: 'walletAddressPlaceholder', coinGeckoId: 'bitcoin'}, 'ETH': { label: 'ETH', networks: ['Ethereum (ERC20)', 'Arbitrum One', 'Optimism'], addressPlaceholderKey: 'walletAddressPlaceholder', coinGeckoId: 'ethereum'} };
      
      function updateUIForCrypto() {
          const selectedCrypto = cryptoSelect.value;
          const config = cryptoConfig[selectedCrypto];
          const lang = 'en'; 
          if (config) {
              validateCryptoNameSpan.textContent = config.label;
              networkSelectEl.innerHTML = '';
              config.networks.forEach(network => {
                  const option = document.createElement('option');
                  option.value = network.toLowerCase().replace(/ /g, '-').replace(/[()]/g, '');
                  option.textContent = network;
                  networkSelectEl.appendChild(option);
              });
              populateAddressIfApplicable(connectedAddress);

              walletAddressInput.placeholder = translations[lang]?.[config.addressPlaceholderKey] || "Wallet Address";
              amountInput.placeholder = translations[lang]?.amountPlaceholder || "Enter amount";
          }
      }
      
      if(cryptoSelect) cryptoSelect.addEventListener('change', updateUIForCrypto);
      if(validateAddressBtn) validateAddressBtn.addEventListener('click', () => { const address = walletAddressInput.value.trim(); const selectedCrypto = cryptoSelect.value; logToAppConsole(`Validating ${selectedCrypto} address: ${address}...`, "info"); validateAddressBtn.disabled = true; setTimeout(() => { let isValid = false; if (selectedCrypto === 'ETH' || selectedCrypto === 'USDT') { isValid = window.ethers && window.ethers.utils.isAddress(address); } else if (selectedCrypto === 'BTC') { isValid = /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(address) || /^(tb1|[mn2])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(address); } else { isValid = address.length > 10; } if (isValid) logToAppConsole(`Address ${address} appears valid for ${selectedCrypto}.`, "success"); else logToAppConsole(`Address ${address} is invalid or not typical for ${selectedCrypto}.`, "error"); validateAddressBtn.disabled = false; }, 1000); });
      
      if(createTransactionBtn) createTransactionBtn.addEventListener('click', () => {
          if (!isLicenseActive) {
              const msg = translations.en.activateLicenseFirst; 
              logToAppConsole(msg, "warn");
              alert(msg); 
              return;
          }
          const selectedCrypto = cryptoSelect.value, toAddressVal = walletAddressInput.value.trim(), amountVal = amountInput.value, networkVal = networkSelectEl.options.length > 0 ? networkSelectEl.options[networkSelectEl.selectedIndex].text : "N/A", proxyVal = document.getElementById('proxy-settings').value; 
          logToAppConsole('Initiating transaction creation (simulation)...', "info"); 
          createTransactionBtn.disabled = true; if(validateAddressBtn) validateAddressBtn.disabled = true; 
          if (!toAddressVal || !amountVal || !networkVal || networkVal === "N/A") { 
              logToAppConsole('Error: Fill Address, Amount, & select Network.', "error"); 
              updateCreateTransactionButtonState(); 
              if(validateAddressBtn) validateAddressBtn.disabled = false; return; 
          } 
          let fromAddressSim = "N/A ("; if (connectedAddress) fromAddressSim = connectedAddress; 
          setTimeout(() => { 
              logToAppConsole(`SIMULATING EVM-like Transaction:\n  Crypto: ${selectedCrypto}\n  From: ${fromAddressSim}\n  To: ${toAddressVal}\n  Amount: ${amountVal}\n  Network: ${networkVal}\n  Proxy: ${proxyVal === 'use-proxy' ? 'Enabled' : 'Disabled'}\n  Flash Duration: ${currentSettings.flashDuration} blocks\n  Transferable: ${currentSettings.isTransferable}\n  Tradable: ${currentSettings.isTradable}\n  Divisible: ${currentSettings.isDivisible}\n\nTxID : 0x${(Math.random().toString(36)+Math.random().toString(36)).replace(/\./g,'').substring(2, 42)}\nStatus: Broadcasted.`, "success"); 
              updateCreateTransactionButtonState(); 
              if(validateAddressBtn) validateAddressBtn.disabled = false; 
          }, 2000); 
      });

      async function fetchAllCryptoPrices() { const ids = 'tether,binancecoin,tron,thorchain,bitcoin,ethereum'; try { const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`); if (!response.ok) throw new Error(`CoinGecko API Error: ${response.status}`); const data = await response.json(); const price = (coin, dec=2) => (data[coin] && data[coin].usd) ? `$${data[coin].usd.toFixed(dec)}` : 'N/A'; document.getElementById('usdt-price').textContent = price('tether', 2); document.getElementById('bnb-price').textContent = price('binancecoin', 2); document.getElementById('tron-price').textContent = price('tron', 4); document.getElementById('th-price').textContent = price('thorchain', 2); } catch (error) { console.error('Error fetching crypto prices:', error); logToAppConsole(`Error fetching crypto prices: ${error.message}`, 'error'); ['usdt-price', 'bnb-price', 'tron-price', 'th-price'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent='Error'; }); } }
      
      function resetAllPlanCards() {
          const lang = 'en'; 
          document.querySelectorAll('.plan-card-modal').forEach(card => {
              const pI = card.querySelector('.payment-info');
              const pA = card.querySelector('.plan-actions');
              const lS = card.querySelector('.license-status');
              const licenseInputGroup = card.querySelector('.license-input-group');
              const licenseKeyInput = card.querySelector('input[id^="license-key-"]');
              const activateBtn = card.querySelector('.btn-activate-license');
              const bB = card.querySelector('.btn-back-to-plans-after-status');
              const aGs = card.querySelectorAll('.address-group');

              if (pI) pI.style.display = 'none';
              if (pA) pA.style.display = 'block';
              if (lS) { lS.style.display = 'none'; lS.innerHTML = ''; lS.className = 'license-status'; }
              if (bB) bB.style.display = 'none';
              
              if (aGs) aGs.forEach(ag => ag.style.display = 'block');
              if (licenseInputGroup) licenseInputGroup.style.display = 'block';
              if (licenseKeyInput) { licenseKeyInput.value = ''; licenseKeyInput.disabled = false; }
              if (activateBtn) {
                  activateBtn.disabled = false;
                  activateBtn.textContent = translations[lang]?.activateLicenseBtn;
              }
          });
      }
      
      function resetModalForm(modalStatusElem, ...inputFields) {
          if (modalStatusElem) {
              modalStatusElem.textContent = '';
              modalStatusElem.className = 'account-status-modal'; // Reset to base class
              modalStatusElem.style.display = 'none';
          }
          inputFields.forEach(input => { if(input) input.value = ''; });
      }

      // Modal Open/Close Handlers
      if(buyLicenseBtn)buyLicenseBtn.onclick=()=>{if(licenseModal){resetAllPlanCards();licenseModal.style.display="flex";}};
      if(closeLicenseModalBtn && licenseModal)closeLicenseModalBtn.onclick=()=>{licenseModal.style.display="none";resetAllPlanCards();};
      
      // Create Account Modal
      if(createAccountBtnTop && createAccountModal) {
        createAccountBtnTop.onclick = () => {
            resetModalForm(accountCreationStatusModal, usernameInputModal, passwordInputModal);
            createAccountModal.style.display="flex";
            logToAppConsole(translations.en.accountFeatureInfo, "info");
        };
      }
      if(closeCreateAccountModalBtn && createAccountModal) {
        closeCreateAccountModalBtn.onclick = () => { createAccountModal.style.display="none"; };
      }
      if(submitCreateAccountBtnModal) {
        submitCreateAccountBtnModal.onclick = () => {
            const username = usernameInputModal.value.trim();
            const password = passwordInputModal.value; 
            const lang = 'en';

            accountCreationStatusModal.style.display = 'block';

            if (!username || !password) {
                accountCreationStatusModal.textContent = translations[lang].fillAllFieldsError;
                accountCreationStatusModal.className = 'account-status-modal error';
                logToAppConsole("Account creation attempt failed: Fields empty.", "error");
                return;
            }

            if (createdAccounts.find(acc => acc.username.toLowerCase() === username.toLowerCase())) {
                accountCreationStatusModal.textContent = translations[lang].usernameTakenError;
                accountCreationStatusModal.className = 'account-status-modal error';
                logToAppConsole(`Account creation attempt failed: Username '${username}' taken.`, "error");
                return;
            }
            
            createdAccounts.push({ username, password }); // WARNING: Insecure password storage
            currentUser = { username }; // Auto-login
            
            accountCreationStatusModal.textContent = translations[lang].accountCreatedSuccess;
            accountCreationStatusModal.className = 'account-status-modal success';
            logToAppConsole(`Account for '${username}' created and logged in. (Password stored in memory - not secure)`, "success");
            
            updateTopBarForLoginState();
            applyTranslations(); // Re-apply to update dynamic texts like welcome message

            setTimeout(() => { 
                createAccountModal.style.display="none"; 
                resetModalForm(accountCreationStatusModal, usernameInputModal, passwordInputModal);
            }, 2000);
        };
      }

      // Login Modal
      if(loginBtnTop && loginModal) {
        loginBtnTop.onclick = () => {
            resetModalForm(loginStatusModal, usernameInputLoginModal, passwordInputLoginModal);
            loginModal.style.display="flex";
            logToAppConsole(translations.en.accountFeatureInfo, "info");
        };
      }
      if(closeLoginModalBtn && loginModal) {
        closeLoginModalBtn.onclick = () => { loginModal.style.display="none"; };
      }
      if(submitLoginBtnModal) {
        submitLoginBtnModal.onclick = () => {
            const username = usernameInputLoginModal.value.trim();
            const password = passwordInputLoginModal.value;
            const lang = 'en';

            loginStatusModal.style.display = 'block';

            if (!username || !password) {
                loginStatusModal.textContent = translations[lang].fillAllFieldsError;
                loginStatusModal.className = 'account-status-modal error';
                return;
            }

            const account = createdAccounts.find(acc => acc.username.toLowerCase() === username.toLowerCase() && acc.password === password);

            if (account) {
                currentUser = { username: account.username };
                loginStatusModal.textContent = translations[lang].loginSuccess;
                loginStatusModal.className = 'account-status-modal success';
                logToAppConsole(`User '${currentUser.username}' logged in successfully.`, "success");
                updateTopBarForLoginState();
                applyTranslations(); 

                setTimeout(() => { 
                    loginModal.style.display="none"; 
                    resetModalForm(loginStatusModal, usernameInputLoginModal, passwordInputLoginModal);
                }, 1500);
            } else {
                loginStatusModal.textContent = translations[lang].loginFailedError;
                loginStatusModal.className = 'account-status-modal error';
                logToAppConsole(`Login failed for username '${username}'.`, "error");
            }
        };
      }

      // My Account Modal & Logout
      if(myAccountBtnTop && myAccountModal) {
        myAccountBtnTop.onclick = () => {
            if (currentUser) {
                myAccountUsernameDisplay.textContent = currentUser.username;
                myAccountModal.style.display = "flex";
            }
        };
      }
      if(closeMyAccountModalBtn && myAccountModal) {
        closeMyAccountModalBtn.onclick = () => { myAccountModal.style.display = "none"; };
      }
      
      function handleLogout() {
          if (currentUser) {
            logToAppConsole(`User '${currentUser.username}' logged out.`, "success");
          }
          currentUser = null;
          updateTopBarForLoginState();
          applyTranslations(); 
          if (myAccountModal) myAccountModal.style.display = "none"; // Close if open
          alert(translations.en.loggedOutSuccess);
      }

      if(logoutBtnTop) logoutBtnTop.onclick = handleLogout;
      if(logoutBtnMyAccountModal) logoutBtnMyAccountModal.onclick = handleLogout;


      if(settingsBtnMain && settingsModal) settingsBtnMain.onclick = () => { settingsModal.style.display="flex"; };
      if(closeSettingsModalBtn && settingsModal) closeSettingsModalBtn.onclick = () => { settingsModal.style.display="none"; };
      if(saveSettingsBtn) saveSettingsBtn.onclick = saveAndApplySettings;

      if (tutorialBtnTop && tutorialModal) {
        tutorialBtnTop.onclick = () => {
            if(tutorialVideoIframe && originalTutorialVideoSrc && tutorialVideoIframe.src !== originalTutorialVideoSrc && !originalTutorialVideoSrc.includes("VIDEO_ID_HERE")) { 
                tutorialVideoIframe.src = originalTutorialVideoSrc;
            } else if (tutorialVideoIframe && originalTutorialVideoSrc.includes("VIDEO_ID_HERE")) {
                 console.warn("Tutorial video placeholder VIDEO_ID_HERE is still in use. Please replace it with a real YouTube video ID.");
            }
            tutorialModal.style.display = "flex";
        };
      }
      if (closeTutorialModalBtn && tutorialModal) {
        closeTutorialModalBtn.onclick = () => {
            tutorialModal.style.display = "none";
            if (tutorialVideoIframe && tutorialVideoIframe.contentWindow) {
                tutorialVideoIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
        };
      }
      
      window.onclick=(event)=>{ 
          if(event.target.classList.contains('app-modal-overlay')){ 
              event.target.style.display="none"; 
              if(event.target.id === 'licensePlansModal') resetAllPlanCards(); 
              if(event.target.id === 'tutorialModal' && tutorialVideoIframe && tutorialVideoIframe.contentWindow) {
                 tutorialVideoIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
              }
          }
      };
      window.addEventListener('keydown',(event)=>{
          if(event.key==='Escape'||event.key==='Esc'){ 
              document.querySelectorAll('.app-modal-overlay').forEach(modal => {
                  if (modal.style.display === "flex") {
                      modal.style.display = "none";
                      if(modal.id === 'licensePlansModal') resetAllPlanCards();
                      if(modal.id === 'tutorialModal' && tutorialVideoIframe && tutorialVideoIframe.contentWindow) {
                          tutorialVideoIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                      }
                  }
              });
          }
      });
      
      document.querySelectorAll('.plan-card-modal').forEach(card => {
          const buyNowBtn = card.querySelector('.btn-buy-modal');
          const activateLicenseBtn = card.querySelector('.btn-activate-license');
          const licenseStatusDiv = card.querySelector('.license-status');
          const backToPlansBtn = card.querySelector('.btn-back-to-plans-after-status');
          const paymentInfoDiv = card.querySelector('.payment-info');
          const planActionsDiv = card.querySelector('.plan-actions');
          const addressGroups = card.querySelectorAll('.address-group');
          const licenseInputGroup = card.querySelector('.license-input-group');
          const licenseKeyInput = card.querySelector('input[id^="license-key-"]');
          const lang = 'en'; 

          if (buyNowBtn) {
              buyNowBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  resetAllPlanCards(); 
                  if (planActionsDiv) planActionsDiv.style.display = 'none';
                  if (paymentInfoDiv) paymentInfoDiv.style.display = 'block';
              });
          }

          if (activateLicenseBtn) {
              activateLicenseBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  const licenseKey = licenseKeyInput ? licenseKeyInput.value.trim().toUpperCase() : "";
                  
                  if (licenseKey.length === 0) {
                      alert(translations[lang]?.enterLicenseKeyAlert);
                      return;
                  }
                  
                  if (addressGroups) addressGroups.forEach(ag => ag.style.display = 'none');
                  if (licenseInputGroup) licenseInputGroup.style.display = 'none';
                  e.target.disabled = true; 
                  e.target.textContent = translations[lang]?.licenseStatusVerifying;

                  if (licenseStatusDiv) {
                      licenseStatusDiv.style.display = 'block';
                      licenseStatusDiv.className = 'output info'; 
                      licenseStatusDiv.textContent = translations[lang]?.licenseStatusVerifying;
                  }
                  if (backToPlansBtn) backToPlansBtn.style.display = 'block';

                  setTimeout(() => { 
                      const isValid = validLicenseKeys.includes(licenseKey);
                      isLicenseActive = isValid; 
                      updateCreateTransactionButtonState(); 

                      if (licenseStatusDiv) {
                          if (isValid) {
                              licenseStatusDiv.className = 'output success';
                              licenseStatusDiv.textContent = translations[lang]?.licenseStatusSuccess;
                              logToAppConsole(`License key ${licenseKey} for ${card.querySelector('h2').textContent} plan activated. Transaction creation ENABLED.`, 'success');
                          } else {
                              licenseStatusDiv.className = 'output error';
                              licenseStatusDiv.textContent = translations[lang]?.licenseStatusError;
                              logToAppConsole(`License key ${licenseKey} for ${card.querySelector('h2').textContent} plan activation FAILED. Transaction creation DISABLED.`, 'error');
                          }
                      }
                  }, 1500);
              });
          }

          if (backToPlansBtn) {
              backToPlansBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  resetAllPlanCards(); 
              });
          }
      });

      document.querySelectorAll('.copy-btn').forEach(b=>{
          b.addEventListener('click',function(){
              const tId=this.dataset.copytarget,aE=document.getElementById(tId);
              if(aE){
                  const aT=aE.innerText;
                  const originalButtonText = translations.en.copyBtn; 
                  navigator.clipboard.writeText(aT).then(()=>{
                      this.textContent = translations.en.copied;
                      this.disabled=true;
                      setTimeout(()=>{
                          this.textContent = originalButtonText;
                          this.disabled=false;
                      },1500);
                  }).catch(err=>{
                      logToAppConsole(`Primary copy failed: ${err}. Fallback.`, 'warn');
                      try{
                          const tA=document.createElement("textarea");
                          tA.value=aT;tA.style.position='fixed';tA.style.opacity='0';
                          document.body.appendChild(tA);tA.focus();tA.select();
                          const suc=document.execCommand('copy');document.body.removeChild(tA);
                          if(suc){
                              this.textContent = translations.en.copied;
                              this.disabled=true;
                              setTimeout(()=>{
                                  this.textContent = originalButtonText;
                                  this.disabled=false;
                              },1500);
                          } else { throw new Error("execCommand failed"); }
                      } catch(fErr){
                          logToAppConsole(`Fallback copy failed: ${fErr}`,'error');
                          alert('Failed to copy.');
                      }
                  });
              }
          });
      });

      logToAppConsole("UI Initializing (v1.5.4 - English Only)...", "info");
      loadSettings(); // This also calls applyTranslations and updateTopBarForLoginState indirectly
      updateWalletButton(false); 
      initWeb3Modal(); 
      updateUIForCrypto(); 
      fetchAllCryptoPrices(); 
      setInterval(fetchAllCryptoPrices, 60000); 
      updateCreateTransactionButtonState(); 
      logToAppConsole("UI Initialized. Language set to English. Create Transaction button requires license activation.", "info");
      if (!translations.en.accountFeatureInfo) { 
        logToAppConsole(translations.en.accountFeatureInfo, "info");
      }
      updateTopBarForLoginState(); // Initial call to set top bar correctly
    });
  </script>
</body>
</html>